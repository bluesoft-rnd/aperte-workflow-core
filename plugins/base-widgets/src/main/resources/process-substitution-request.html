<#assign null = "null"/>
<#assign canEdit = privileges?seq_contains("EDIT")?string("yes", "no")/>

<#assign creatorName = process.getSimpleAttributeValue("creatorName")!""/>
<#assign substitutingUserLogin = process.getSimpleAttributeValue("substitutingUserLogin")!""/>
<#assign substitutingUserLoginFullName = process.getSimpleAttributeValue("substitutingUserLoginFullName")!""/>
<#assign substitutingDateFrom = process.getSimpleAttributeValue("substitutingDateFrom")!""/>
<#assign substitutingDateTo = process.getSimpleAttributeValue("substitutingDateTo")!""/>

<style type="text/css">
    .form-control.demand-typeof-textarea {height: 115px; width: 100%;}
    .form-control.demand-placeofuse-textarea { width: 100%;}
    .form-control.demand-account-select { width: 100%;}
    .row.row-general-info {margin-right: 5px; }
    .required:after {content: " *";  color: red;}
</style>

<div>
    <div class="panel panel-default">
        <div class="panel-body">
            <div class="form-horizontal">
                <div class="row form-group">
                    <div class="col-sm-2">
                        <label name="tooltip" data-placement="bottom" title="${messageSource.getMessage('substituting.user.label.tooltip')}"  class="control-label">${messageSource.getMessage("substituting.user.label")}</label>
                    </div>
                    <div  class="col-sm-10">
                        <h4 >${creatorName}</h4>
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-sm-2">
                        <label name="tooltip" title="${messageSource.getMessage('substitute.user.label.tooltip')}" for="substitute-user-${widgetId}" class="control-label required">${messageSource.getMessage("substitute.user.label")}</label>
                    </div>
                    <div  class="col-sm-10">
                        <input id="substitute-user-${widgetId}"  data-placeholder="${messageSource.getMessage('substituting.user.input.placeholder')}" <#if canEdit == "no">disabled</#if>/>
                    </div>
                </div>
                <div class="row form-group">

                    <div class="col-sm-2">
                        <label name="tooltip" title="${messageSource.getMessage('substituting.date.from.tooltip')}" for="substituting-date-from-${widgetId}" class="control-label required">${messageSource.getMessage("substituting.date.from.label")}</label>
                    </div>
                    <div  class="col-sm-10">
                        <div class="input-group input-group-sm  input-append date" id="substituting-date-from-datepicker-${widgetId}" <#if canEdit == "no">disabled</#if>>
                        <input type="text" class="form-control" value="${substitutingDateFrom}" data-placeholder="${messageSource.getMessage('substituting.user.datefrom.placeholder')}"  id="substituting-date-from-${widgetId}" <#if canEdit == "no">disabled</#if>>
                        <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                    </div>
                </div>
            </div>
            <div class="row form-group">


                <div class="col-sm-2">
                    <label name="tooltip" title="${messageSource.getMessage('substituting.date.to.tooltip')}" for="substituting-date-to-${widgetId}" class="control-label required">${messageSource.getMessage("substituting.date.to.label")}</label>
                </div>
                <div class="col-sm-10">
                    <div class="input-group input-group-sm  input-append date" id="substituting-date-to-datepicker-${widgetId}" >
                        <input type="text" class="form-control"  id="substituting-date-to-${widgetId}" value="${substitutingDateTo}" <#if canEdit == "no">disabled</#if>>
                        <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>


</div>

<script type="text/javascript">

    $(document).ready(function()
    {
		var widget = new Widget('${widgetName}', '${widgetId}', '${task.internalTaskId}');
		widget.getData = function() {return getSubstitutingRequestData();};
		widget.validate = function() {return validateSubstitutingRequestData();};
		widget.isEnabled = "${canEdit}" == "no" ? false : true;
		widgets.push(widget);

		$("#substitute-user-${widgetId}").select2(
		{
		    minimumInputLength: 3,
            ajax: {
                url: dispatcherPortlet,
                dataType: 'json',
                quietMillis: 200,
                data: function (term, page) {
                    return {
                        q: term, // search term
                        page_limit: 10,
                        controller: "usercontroller",
                        page: page,
                        action: "getAllUsers"
                    };
                },
                results: function (data, page)
                {
                    var results = [];
                      $.each(data.data, function(index, item)
                      {
                        if('${user.getLogin()}' != item.login)
                        {
                            results.push({
                              id: item.login,
                              text: item.realName + ' ['+item.login+']'
                            });
                        }
                      });
                      return {
                          results: results
                      };
                }
            },
            initSelection: function(element, callback)
            {
                var id=$(element).val();
                if(id != "")
                {
                    var data = {id:'${substitutingUserLogin}',text:'${substitutingUserLoginFullName}'};
                    callback(data);
                }
            }
        }).select2('readonly', "${canEdit}" == "no");
        $("#substitute-user-${widgetId}").select2('val', '${substitutingUserLoginFullName}');


        <#if canEdit != "no">
            $("#substituting-date-from-datepicker-${widgetId}").datepicker({
                format: "dd-mm-yyyy",
                startDate: moment().format("DD-MM-YYYY"),
                language: "pl",
                minDate: 0,
                autoclose:true,
                todayHighlight : true
            });
        </#if>


        <#if canEdit != "no">
            $("#substituting-date-to-datepicker-${widgetId}").datepicker({
                format: "dd-mm-yyyy",
                startDate: moment().format("DD-MM-YYYY"),
                language: "pl",
                minDate: 0,
                autoclose:true,
                todayHighlight : true
            });
        </#if>


    });
    	function validateSubstitutingRequestData(){
		var errors = [];
		if("${canEdit}" == "no") { return errors; }

		var substitutingUserLogin = $('#substitute-user-${widgetId}').val();
		var substitutingDateFrom = $('#substituting-date-from-${widgetId}').val();
        var substitutingDateTo = $('#substituting-date-to-${widgetId}').val();

		if(!substitutingUserLogin) {
			$('#warning').show();
			errors.push('${messageSource.getMessage("substitute.user.empty")}');
		}

		var now = moment().startOf('day');

		if(!substitutingDateFrom)
		{
			$('#warning').show();
			errors.push('${messageSource.getMessage("substituting.date.from.empty")}');
		}
		else
		{
		    var dateFrom = typeof substitutingDateFrom == 'string' ? moment(substitutingDateFrom, "DD-MM-YYYY") : null;

		    if ((dateFrom.isValid()) && (now.isAfter(dateFrom))){
                $('#warning').show();
                errors.push('${messageSource.getMessage("substituting.date.from.past")}');
            }
        }

        if(!substitutingDateTo)
		{
			$('#warning').show();
			errors.push('${messageSource.getMessage("substituting.date.to.empty")}');
		}
		else
		{
			var dateTo = typeof substitutingDateFrom == 'string' ? moment(substitutingDateTo, "DD-MM-YYYY") : null;
			var dateFrom = typeof substitutingDateFrom == 'string' ? moment(substitutingDateFrom, "DD-MM-YYYY") : null;

		    if ((dateTo.isValid()) && (now.isAfter(dateTo))){
                $('#warning').show();
                errors.push('${messageSource.getMessage("substituting.date.to.past")}');
            }
            else if(substitutingDateTo && substitutingDateFrom && dateTo.isBefore(dateFrom, 'day'))
            {
                $('#warning').show();
                errors.push('${messageSource.getMessage("substituting.date.fromto.lesser")}');
            }
        }

		return errors;
	}

	function getSubstitutingRequestData()
	{
	    if("${canEdit}" == "no") { return []; }

        var substitutingUserLogin = $('#substitute-user-${widgetId}').val();
        var substitutingUserLoginFullName;
        if($('#substitute-user-${widgetId}').select2('data'))
        {
            substitutingUserLoginFullName = $('#substitute-user-${widgetId}').select2('data').text;
        }
        var substitutingDateFrom = $('#substituting-date-from-${widgetId}').val();
        var substitutingDateTo = $('#substituting-date-to-${widgetId}').val();

		var data = [
		    {"key" : "substitutingUserLogin", "value": substitutingUserLogin, "type" : "simple" },
		    {"key" : "substitutingUserLoginFullName", "value": substitutingUserLoginFullName, "type" : "simple" },
		    {"key" : "substitutingDateFrom", "value": substitutingDateFrom, "type" : "simple" },
		    {"key" : "substitutingDateTo", "value": substitutingDateTo, "type" : "simple" }
        ];

		return data;
	}

</script>