<#assign null = "null"/><#if attributesProvider.processInstance??>    <#assign providerId = attributesProvider.processInstance.getId()!""/>    <#assign controllerName = 'filescontroller'/><#else>    <#assign providerId = attributesProvider.getId()!""/>    <#assign controllerName = 'casefilescontroller'/></#if><#assign userLogin = user.getLogin()!""/><#if attributesProvider.assignee??>    <#assign assignee = attributesProvider.assignee!""/><#else>    <#assign assignee = userLogin /></#if><#if !files??>    <#assign files = processInstanceFiles/></#if><#assign mode = privileges?seq_contains("EDIT")?string("edit", "view")/><#if mode != "edit">    <#assign mode = privileges?seq_contains("MIXED")?string("mixed", "view")/>    <#if mode != "mixed">        <#assign mode = "view"/>    </#if></#if><#if mode = "mixed">    <#if assignee != userLogin>        <#assign mode = "view"/>    </#if></#if><#assign deleteAreYouSure = messageSource.getMessage("widget.file.repository.results.table.delete.areYouSure")/><#assign updateDescriptionAreYouSure = messageSource.getMessage("widget.file.repository.results.table.updateDescription.areYouSure")/><#assign updateDescriptionSuccess = messageSource.getMessage("widget.file.repository.results.table.updateDescription.success")/><!-- Important: macros fileTableTr fileTableTrJs should not be formated due to javascript processor lack of new lines handling --><#macro fileTableTr fileId fileName fileDescription fileCreateDate fileCreatorLogin><tr class="file-tr-l-${fileCreatorLogin}-l"><td class="fileId" style="display:none">${fileId}</td> <td class="fileName"><a href="#" class="fileNameDownloadHref">${fileName}</a></td> <td class="fileDescription"><span class="editableText">${fileDescription!}</span></td> <td class="fileCreateDate">${fileCreateDate}</td><td>${fileCreatorLogin}</td></td><td><button class="btn btn-xs downloadFileBtn" style="margin-right: 10px;"alt="${messageSource.getMessage('widget.file.repository.results.table.downloadBtn')}"><span class="glyphicon glyphicon-floppy-save"/></button> <button class="btn btn-xs deleteFileBtn" style="margin-right: 10px;"alt="${messageSource.getMessage('widget.file.repository.results.table.deleteBtn')}"><span class="glyphicon glyphicon-remove"/></button> </td> </tr></#macro><#macro fileTableTrJs><@fileTableTr fileId="%%fileId%%" fileName="%%fileName%%" fileDescription="%%fileDescription%%" fileCreateDate="%%fileCreateDate%%" fileCreatorLogin="%%fileCreatorLogin%%"/></#macro><div class="panel panel-default"><div class="panel-heading">${messageSource.getMessage("widget.file.repository.title")}</div><div class="panel-body"><!-- The fileinput-button span is used to style the file input field as button --><br/><span class="btn btn-success fileinput-button" style="display:none;">  <i class="glyphicon glyphicon-plus"></i>  <span>${messageSource.getMessage("widget.file.repository.form.addFileBtn")}</span>  <!-- The file input field used as target for the file upload widget -->  <input id="fileupload" type="file" name="files[]"></span><span id="file-error" class="label label-danger" style="display:none;font-size: 14px;"></span><br/><br/><!-- The container for the uploaded files --><div id="files" class="files"></div><!-- The global progress bar --><div id="progress" class="progress" style="display:none;">    <div class="progress-bar progress-bar-success"></div></div><table cellpadding="0" cellspacing="0" border="0" id="files-table" class="table table-hover table-bordered">    <thead>    <tr>        <th class="id" style="display:none">${messageSource.getMessage("widget.file.repository.results.table.id")}        </th>        <th class="name" style="width: 40px">${messageSource.getMessage("widget.file.repository.results.table.name")}        </th>        <th class="description" style="width: 120px">            ${messageSource.getMessage("widget.file.repository.results.table.description")}        </th>        <th class="createDate" style="width: 80px">            ${messageSource.getMessage("widget.file.repository.results.table.createdDate")}        </th>        <th class="creatorLogin" style="width: 80px">            ${messageSource.getMessage("widget.file.repository.results.table.creatorLogin")}        </th>        <th style="width: 30px">${messageSource.getMessage("widget.file.repository.results.table.fileAction")}</th>    </tr>    </thead>    <tbody>    <#list files as file>        <@fileTableTr fileId=file.id?c fileName=file.name fileDescription=file.description!        fileCreateDate=file.createDate fileCreatorLogin=file.creatorLogin/>    </#list>    </tbody></table></div></div><script>    function downloadURL(url) {        var hiddenIFrameID = 'hiddenDownloader',                iframe = document.getElementById(hiddenIFrameID);        if (iframe === null) {            iframe = document.createElement('iframe');            iframe.id = hiddenIFrameID;            iframe.style.display = 'none';            document.body.appendChild(iframe);        }        iframe.src = url;    }    function getFileUploadDispatcherPortletFor(controller, action) {        var noReplyDispatcherPortlet = dispatcherPortlet.replace('=dispatcher&','=fileUploadDispatcher&');        var url = noReplyDispatcherPortlet + '&controller=' + controller + '&action=' + action + '&processInstanceId=${providerId}'        return url;    }    function getNoReplyDispatcherPortletFor(controller, action) {        var noReplyDispatcherPortlet = dispatcherPortlet.replace('=dispatcher&','=noReplyDispatcher&');        var url = noReplyDispatcherPortlet + '&controller=' + controller + '&action=' + action + '&processInstanceId=${providerId}'        return url;    }    function getDispatcherPortletFor(controller, action) {        var url = dispatcherPortlet + '&controller=' + controller + '&action=' + action + '&processInstanceId=${providerId}'        return url;    }    // Change this to the location of your server-side upload handler:    var urlUploadFile = getFileUploadDispatcherPortletFor('${controllerName}', 'uploadFile'),            urlGetFilesList = getDispatcherPortletFor('filescontroller', 'getFilesList'),            urlDownloadFile = getNoReplyDispatcherPortletFor('${controllerName}', 'downloadFile'),            urlDeleteFile = getDispatcherPortletFor('${controllerName}', 'deleteFile'),            urlUpdateDescription = getDispatcherPortletFor('${controllerName}', 'updateDescription');    function initTable(mode) {        $('.downloadFileBtn').unbind("click").on('click', function (e) {            e.preventDefault();            var row = $(this).closest('tr');            var itemId = row.find('td.fileId').text();                        downloadURL(urlDownloadFile + '&filesRepositoryItemId=' + itemId);        });        $('.deleteFileBtn').unbind("click").on('click', function (e) {            e.preventDefault();            var row = $(this).closest('tr');            var itemId = row.find('td.fileId').text();            var fileName = row.find('td.fileName').text();            var msgConfirm = '${deleteAreYouSure}';            msgConfirm = msgConfirm.replace('{0}', fileName);            if (confirm(msgConfirm)) {                $.getJSON(urlDeleteFile + '&filesRepositoryItemId=' + itemId)                        .done(function (data) {                            if (data.errors.length > 0) {                                $(data.errors).each(function (index) {                                    alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);                                });                                return;                            }                            row.remove();                        });            }        });        $('#files-table tr').each(function() {            makeFileNameClickable($(this));        });        if("${mode}" == "edit") {            $('.fileinput-button').show();            $('#files-table tr').each(function() {                makeEditableOnClick($(this));            });        } else if ("${mode}" == "mixed") {            $('.fileinput-button').show();            var rowsToEnable = $('#files-table').find('tr[class^="file-tr-l"]').filter('tr[class="file-tr-l-${userLogin}-l"]');            $(rowsToEnable).each(function() {                makeEditableOnClick($(this));            });            var rowsToDisable = $('#files-table').find('tr[class^="file-tr-l"]:not(tr[class="file-tr-l-${userLogin}-l"])');            $(rowsToDisable).find('button.deleteFileBtn').prop('disabled', true).hide();        } else if("${mode}" == "view") {            var disabledBtn = $('#files-table button.deleteFileBtn');            disabledBtn.prop('disabled', true);            disabledBtn.hide();        }    }    function saveDescriptionBtnClick(e) {        e.preventDefault();        var row = $(this).closest('tr');        var itemId = row.find('td.fileId').text();        var description = row.find('input.description-text').val();        var fileName = row.find('td.fileName').text();        $.getJSON(urlUpdateDescription + '&filesRepositoryItemId=' + itemId + '&fileDescription=' + description)                .done(function (data) {                    if (data.errors.length > 0) {                        $(data.errors).each(function (index) {                            alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);                        });                        return;                    }                    var msgSuccess = '${updateDescriptionSuccess}';                    msgSuccess = msgSuccess.replace('{0}', fileName);                    var tdDesc = $(row.find('td.fileDescription')[0]);                    tdDesc.empty();                    tdDesc.append($("<span class='editableText'/>").append(description));                    tdDesc.css('cursor', 'inherit');                    var tr = $(tdDesc.closest('tr'));                    makeEditableOnClick(tr);                });    }    function makeFileNameClickable(tr) {        var aHref = tr.find('.fileNameDownloadHref');        var itemId = tr.find('td.fileId').text();        var url = urlDownloadFile + '&filesRepositoryItemId=' + itemId;        aHref.attr('href', encodeURI(url));    }    function makeEditableOnClick(tr) {        var editableTextSpan = tr.find('span.editableText');        var editDescHtml = '<div class="input-group input-group-sm"> <input type="text" class="description-text form-control"> <span class="input-group-btn"> <button class="btn btn-default description-change-btn" type="button">${messageSource.getMessage("widget.file.repository.results.table.saveBtn")}</button> </span> </div>'        var editDesc = $(editDescHtml);        var currText = '';        if(editableTextSpan.children().length > 0) {            currText = $(editableTextSpan).find('input.description-text').val();        } else {            currText = editableTextSpan.text();        }        editDesc.find('input.description-text').val(currText);        editableTextSpan.closest('td').css('cursor', 'text');        editableTextSpan.closest('td').unbind('click').on('click', function(e) {            e.preventDefault();            editableTextSpan.empty();            editableTextSpan.append(editDesc);            editableTextSpan.find('input.description-text').focus();            editableTextSpan.find('.description-change-btn').unbind("click").on('click', saveDescriptionBtnClick);            $(this).unbind('click');        });    }    $(document).ready(function () {        var MAX_FILE_SIZE = 50000000;        initTable("${mode}");        $('#fileupload').fileupload({            url: urlUploadFile,            dropZone: null,            pasteZone: null,            maxFileSize: MAX_FILE_SIZE,            dataType: 'json',            autoUpload: true,            messages: {                maxFileSize: 'Maksymalny dozwolony rozmiar pliku to ' + (MAX_FILE_SIZE/1000000) + " MB."            }        })        .on('fileuploadadd', function (e, dataObj) {                    dataObj.context = $('<div/>').appendTo('#fileupload');                })        .on('fileuploadprocessalways', function (e, data) {            $('#file-error').text('');            $('#file-error').hide();            var index = data.index,                    file = data.files[index],                    node = $(data.context.children()[index]);            if (file.error) {//                node//                        .append('<br>')//                        .append($('<span class="text-danger"/>').text(file.error));//                alert(file.error);                  $('#file-error').text(file.error);                  $('#file-error').show();            }            if (index + 1 === data.files.length) {                data.context.find('button')                        .text('Upload')                        .prop('disabled', !!data.files.error);            }        })        .on('fileuploadprogressall', function (e, data) {            $('#progress').show();            var progress = parseInt(data.loaded / data.total * 100, 10);            $('#progress .progress-bar').css(                    'width',                    progress + '%'            );        })        .on('fileuploaddone',function (e, dataObj) {            $('#progress').hide();            data = dataObj.jqXHR != null ? dataObj.jqXHR.responseJSON : dataObj;            if (data.errors.length > 0) {                $(data.errors).each(function (index) {                    alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);                });                return;            }            var file = data.data;            var newRowTrHtml = '<@fileTableTrJs/>'                    .replace(new RegExp('%%fileId%%', 'g'), file.id)                    .replace(new RegExp('%%fileName%%', 'g'), file.name)                    .replace(new RegExp('%%fileDescription%%', 'g'), file.description != null ? file.description : "")                    .replace(new RegExp('%%fileCreateDate%%', 'g'), file.createDate)                    .replace(new RegExp('%%fileCreatorLogin%%', 'g'), file.creatorLogin);            var newRowTr = $(newRowTrHtml);            makeEditableOnClick(newRowTr);            newRowTr.find('span.editableText').closest('td').click();            $('#files-table').append(newRowTr);            initTable("${mode}");        }).on('fileuploadfail',function (e, dataObj) {            data = dataObj.jqXHR != null ? dataObj.jqXHR.responseJSON : dataObj;            if (data.errors.length > 0) {                $(data.errors).each(function (index) {                    alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);                });                return;            }        }).prop('disabled', !$.support.fileInput)        .parent().addClass($.support.fileInput ? undefined : 'disabled');    });</script>