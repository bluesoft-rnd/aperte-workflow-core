<#assign null = "null"/>
<#assign isMailMode =((mode!"STANDARD")=="MAIL")>
<#if attributesProvider.processInstance??>
    <#assign providerId = attributesProvider.processInstance.getId()!""/>
    <#assign controllerName = 'filescontroller'/>
<#else>
    <#assign providerId = attributesProvider.getId()!""/>
    <#assign controllerName = 'casefilescontroller'/>
</#if>

<#assign userLogin = user.getLogin()!""/>
<#if attributesProvider.assignee??>
    <#assign assignee = attributesProvider.assignee!""/>
<#else>
    <#assign assignee = userLogin />
</#if>
<#if !files??>
    <#assign files = processInstanceFiles/>
</#if>
<#assign viewMode = privileges?seq_contains("EDIT")?string("edit", "view")/>
<#if viewMode != "edit">
    <#assign viewMode = privileges?seq_contains("MIXED")?string("mixed", "view")/>
    <#if viewMode != "mixed">
        <#assign viewMode = "view"/>
    </#if>
</#if>
<#if viewMode = "mixed">
    <#if assignee != userLogin>
        <#assign viewMode = "view"/>
    </#if>
</#if>

<#assign deleteAreYouSure = messageSource.getMessage("widget.file.repository.results.table.delete.areYouSure")/>
<#assign updateDescriptionAreYouSure = messageSource.getMessage("widget.file.repository.results.table.updateDescription.areYouSure")/>
<#assign updateDescriptionSuccess = messageSource.getMessage("widget.file.repository.results.table.updateDescription.success")/>

<style type="text/css">
    .red{
        color: red;
    }
    .ellips{
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .fileNameDownloadHref
    {
        height:18px;
    }
</style>

<!-- Important: macros fileTableTr fileTableTrJs should not be formated due to javascript processor lack of new lines handling -->
<#macro fileTableTr fileId fileName fileDescription fileCreateDate fileCreatorLogin fileSendWithMail b="" e="">
${b}	<tr class="file-tr-l-${fileCreatorLogin}-l">${e}
${b}		<td class="fileId" style="display:none">${fileId}</td>${e}
${b}		<td class="fileName"><a href="#" class="fileNameDownloadHref ellips"><span class="js-file-icon" data-id="${fileId}"></span><span class="js-file-name" data-id="${fileId}">${fileName?html}</span></a></td>${e}
${b}		<td class="fileDescription"><input type="text" maxlength="255" class="form-control file-description-input" style="font-size: 12px; width:100%; height:100%; line-height: 10px; padding: 4px 0px 0px 0px;" placeholder="Opis dokumentu" value="${(fileDescription!"")?html}"/></td>${e}
${b}		<#if isMailMode>${e}
${b}			<td>${e}
${b}				<div class="checkbox">${e}
${b}					<label><input type="checkbox" class="fileSendWithMail" <#if fileSendWithMail == "true">checked</#if>></label>${e}
${b}				</div>${e}
${b}			</td>${e}
${b}		</#if>${e}
${b}		<td>${e}
${b}			<button class="btn btn-xs downloadFileBtn" style="margin-right: 10px;" alt="Pobierz plik">${e}
${b}				<span class="glyphicon glyphicon-floppy-save"/>${e}
${b}			</button>${e}
${b}			<button class="btn btn-xs deleteFileBtn" style="margin-right: 10px;" alt="Usuń plik">${e}
${b}				<span class="glyphicon glyphicon-trash red"/>${e}
${b}			</button>${e}
${b}		</td>${e}
${b}	</tr>${b}
</#macro>
<#macro fileTableTrJs><@fileTableTr fileId="%%fileId%%" fileName="%%fileName%%" fileDescription="%%fileDescription%%" fileCreateDate="%%fileCreateDate%%" fileCreatorLogin="%%fileCreatorLogin%%" fileSendWithMail="%%fileSendWithMail%%" b="'" e="\\n'+"/></#macro>

<div class="panel panel-default">
	<div class="panel-body">
		<style type="text/css">
			#files-table {table-layout: fixed; width: 100%}
			#files-table td {
				background-color: transparent;
                padding: 0px;
			}
		</style>

		<div class="form-group col-md-12" >
			<table cellpadding="0" cellspacing="0" border="0" id="files-table" class="table table-hover table-bordered narrow-rows" style="border-collapse:collapse;">
				<colgroup>
					<col>
					<col>
					<col width="100px;">
				</colgroup>
				<thead style="display: none;">
					<tr>
						<th class="name" style="width: 40px">
							Nazwa
						</th>
						<th class="description" style="width: 40px">
							Opis
						</th>
						<th style="width: 30px">
							Akcja
						</th>
					</tr>
				</thead>
				<tbody>
					<#list files?sort_by("createDate", "name") as file>
						<@fileTableTr fileId=file.id?c fileName=file.name fileDescription=file.description!
						fileCreateDate=file.createDate?string("dd-MM-yy HH:mm") fileCreatorLogin=file.creatorLogin fileSendWithMail=(file.sendWithMail!false)?string("true", "false")/>
					</#list>
				</tbody>
			</table>

			<!-- The fileinput-button span is used to style the file input field as button -->
			<span class="btn btn-link fileinput-button">
				  <i class="glyphicon glyphicon-paperclip" style="font-size: 19px;"></i>
				  <span style="font-weight: bold;">Dodaj załącznik do sprawy</span>
				  <!-- The file input field used as target for the file upload widget -->
				  <input id="fileupload" type="file" name="files[]">
			</span>
			<span id="file-error" class="label label-danger" style="display:none;font-size: 14px;"></span>
			<!-- The container for the uploaded files -->
			<div id="files" class="files"></div>
			<!-- The global progress bar -->
			<div id="progress" class="progress" style="display:none;">
				<div class="progress-bar progress-bar-success"></div>
			</div>
		</div>
	</div>
</div>

<script>
	function applyIconsToFileNames(){
        $('.js-file-name').each(function(){
            var fileId = this.getAttribute('data-id');
            var fileName = $(this).text();
            var iconHtml = getFileIconHtml(fileName);
            $('.js-file-icon[data-id='+fileId+']').html(iconHtml+' ');
        });
	}

    function downloadURL(url) {
        var hiddenIFrameID = 'hiddenDownloader',
                iframe = document.getElementById(hiddenIFrameID);
        if (iframe === null) {
            iframe = document.createElement('iframe');
            iframe.id = hiddenIFrameID;
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
        }
        iframe.src = url;
    }

    function getFileUploadDispatcherPortletFor(controller, action) {
        var noReplyDispatcherPortlet = dispatcherPortlet.replace('=dispatcher&','=fileUploadDispatcher&');
        var url = noReplyDispatcherPortlet + '&controller=' + controller + '&action=' + action + '&processInstanceId=${providerId?c}'
        return url;
    }

    function getNoReplyDispatcherPortletFor(controller, action) {
        var noReplyDispatcherPortlet = dispatcherPortlet.replace('=dispatcher&','=noReplyDispatcher&');
        var url = noReplyDispatcherPortlet + '&controller=' + controller + '&action=' + action + '&processInstanceId=${providerId?c}'
        return url;
    }

    function getDispatcherPortletFor(controller, action) {
        var url = dispatcherPortlet + '&controller=' + controller + '&action=' + action + '&processInstanceId=${providerId?c}'
        return url;
    }

    // Change this to the location of your server-side upload handler:
    var urlUploadFile = getFileUploadDispatcherPortletFor('${controllerName}', 'uploadFile'),
            urlGetFilesList = getDispatcherPortletFor('filescontroller', 'getFilesList'),
            urlDownloadFile = getNoReplyDispatcherPortletFor('${controllerName}', 'downloadFile'),
            urlDeleteFile = getDispatcherPortletFor('${controllerName}', 'deleteFile'),
            urlMarkAsSendWithMail = getDispatcherPortletFor('${controllerName}', 'updateSendWithMail'),
            urlUpdateDescription = getDispatcherPortletFor('${controllerName}', 'updateDescription');

    function initTable(viewMode) {

        $('.downloadFileBtn').unbind("click").on('click', function (e) {
            e.preventDefault();
            var row = $(this).closest('tr');
            var itemId = row.find('td.fileId').text();

            downloadURL(urlDownloadFile + '&filesRepositoryItemId=' + itemId);
        });

        $('.fileSendWithMail').unbind("click").on('click', function (e) {
            var row = $(this).closest('tr');
            var itemId = row.find('td.fileId').text();

            var sendWithMail = $(this).is(':checked');
            $.getJSON(urlMarkAsSendWithMail + '&filesRepositoryItemId=' + itemId+ '&fileSendWithMail=' + encodeURIComponent(sendWithMail));
        });

        $('.deleteFileBtn').unbind("click").on('click', function (e) {
            e.preventDefault();
            var row = $(this).closest('tr');
            var itemId = row.find('td.fileId').text();
            var fileName = row.find('td.fileName').text();
            var msgConfirm = '${deleteAreYouSure?js_string}';
            msgConfirm = msgConfirm.replace('{0}', fileName);
            if (confirm(msgConfirm)) {
                $.getJSON(urlDeleteFile + '&filesRepositoryItemId=' + itemId)
                        .done(function (data) {
                            if (data.errors.length > 0) {
                                $(data.errors).each(function (index) {
                                    alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);
                                });
                                return;
                            }
                            row.remove();
                        });
            }
        });

        $('#files-table tr').each(function() {
            makeFileNameClickable($(this));
        });

        if("${viewMode}" == "edit") {
            $('.fileinput-button').show();
            $('#files-table tr ').each(function() {
                makeEditableOnClick($(this));
            });
        } else if ("${viewMode}" == "mixed") {
            $('.fileinput-button').show();
            var rowsToEnable = $('#files-table').find('tr[class^="file-tr-l"]').filter('tr[class="file-tr-l-${userLogin}-l"]');
            $(rowsToEnable).each(function() {
                makeEditableOnClick($(this));
            });
            var rowsToDisable = $('#files-table').find('tr[class^="file-tr-l"]:not(tr[class="file-tr-l-${userLogin}-l"])');
            $(rowsToDisable).find('button.deleteFileBtn').prop('disabled', true).hide();
        } else if("${viewMode}" == "view") {
            var disabledBtn = $('#files-table button.deleteFileBtn');
            disabledBtn.prop('disabled', true);
            disabledBtn.hide();
        }
    }

    function saveDescriptionBtnClick(e) {
        e.preventDefault();
        var row = $(this).closest('tr');
        var itemId = row.find('td.fileId').text();
        var description = row.find('input.description-text').val();
        var fileName = row.find('td.fileName').text();
        $.getJSON(urlUpdateDescription + '&filesRepositoryItemId=' + itemId + '&fileDescription=' + encodeURIComponent(description))
                .done(function (data) {
                    if (data.errors.length > 0) {
                        $(data.errors).each(function (index) {
                            alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);
                        });
                        return;
                    }
                    var msgSuccess = '${updateDescriptionSuccess?js_string}';
                    msgSuccess = msgSuccess.replace('{0}', fileName);

                    var tdDesc = $(row.find('td.fileDescription')[0]);
                    tdDesc.empty();
                    tdDesc.append($("<span class='editableText'/>").append(description));
                    tdDesc.css('cursor', 'inherit');
                    var tr = $(tdDesc.closest('tr'));
                    makeEditableOnClick(tr);
                });
    }

    function makeFileNameClickable(tr) {
        var aHref = tr.find('.fileNameDownloadHref');
        var itemId = tr.find('td.fileId').text();
        var url = urlDownloadFile + '&filesRepositoryItemId=' + itemId;
        aHref.attr('href', encodeURI(url));
    }

    function makeEditableOnClick(tr) {
    	tr.find('.file-description-input').unbind().change(function() {
			var row = $(this).closest('tr');
        	var itemId = row.find('td.fileId').text();
        	var description = $(this).val();

			$.getJSON(urlUpdateDescription + '&filesRepositoryItemId=' + itemId + '&fileDescription=' + encodeURIComponent(description))
			.done(function (data) {
				if (data.errors.length > 0) {
					$(data.errors).each(function (index) {
						alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);
					});
					return;
				}
			});
    	});
        /*var editableTextSpan = tr.find('span.editableText');
        var editDescHtml = '<div class="input-group input-group-sm"> <input type="text" maxlength="255" class="description-text form-control"> <span class="input-group-btn"> <button class="btn btn-default description-change-btn" type="button">${messageSource.getMessage("widget.file.repository.results.table.saveBtn")}</button> </span> </div>'
        var editDesc = $(editDescHtml);
        var currText = '';
        if(editableTextSpan.children().length > 0) {
            currText = $(editableTextSpan).find('input.description-text').val();
        } else {
            currText = editableTextSpan.text();
        }
        editDesc.find('input.description-text').val(currText);
        editableTextSpan.closest('td').css('cursor', 'text');
        editableTextSpan.closest('td').unbind('click').on('click', function(e) {
            e.preventDefault();
            editableTextSpan.empty();
            editableTextSpan.append(editDesc);
            editableTextSpan.find('input.description-text').focus();
            editableTextSpan.find('.description-change-btn').unbind("click").on('click', saveDescriptionBtnClick);
            $(this).unbind('click');
        });*/
    }

    $(document).ready(function () {

        var MAX_FILE_SIZE = 50000000;

        initTable("${viewMode}");

        $('#fileupload').fileupload({
        	forceIframeTransport: true,
            url: urlUploadFile,
            dropZone: null,
            pasteZone: null,
            maxFileSize: MAX_FILE_SIZE,
            dataType: 'json',
            autoUpload: true,
            messages: {
                maxFileSize: 'Maksymalny dozwolony rozmiar pliku to ' + (MAX_FILE_SIZE/1000000) + " MB."
            }
        })
        .on('fileuploadadd', function (e, dataObj) {
                    dataObj.context = $('#fileupload').append($("<div><div></div></div>").innerHTML);
                })
        .on('fileuploadprocessalways', function (e, data) {

            $('#file-error').text('');
            $('#file-error').hide();

            var index = data.index,
                    file = data.files[index],
                    node = $(data.context.children()[index]);
            if (file.error) {
                  $('#file-error').text(file.error);
                  $('#file-error').show();
            }
            if (index + 1 === data.files.length) {
                data.context.find('button')
                        .text('Upload')
                        .prop('disabled', !!data.files.error);
            }

        })
        .on('fileuploadprogressall', function (e, data) {

            $('#progress').show();
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress .progress-bar').css(
                    'width',
                    progress + '%'
            );
        })
        .on('fileuploaddone',function (e, dataObj) {

            $('#progress').hide();

            data = dataObj.jqXHR != null ? dataObj.jqXHR.responseJSON : dataObj;

            if (data.errors.length > 0) {
                $(data.errors).each(function (index) {
                    alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);
                });
                return;
            }

            var file = data.data;
            var newRowTrHtml = (<@fileTableTrJs/>)
                    .replace(new RegExp('%%fileId%%', 'g'), file.id)
                    .replace(new RegExp('%%fileName%%', 'g'), file.name)
                    .replace(new RegExp('%%fileDescription%%', 'g'), file.description != null ? file.description : "")
                    .replace(new RegExp('%%fileCreateDate%%', 'g'), moment(file.createDate).format('DD-MM-YYYY HH:mm'))
                    .replace(new RegExp('%%fileCreatorLogin%%', 'g'), file.creatorLogin)
                    .replace(new RegExp('%%fileSendWithMail%%', 'g'), file.sendWithMail);

            var newRowTr = $(newRowTrHtml);

            makeEditableOnClick(newRowTr);
            newRowTr.find('span.editableText').closest('td').click();

            $('#files-table').append(newRowTr);

            initTable("${viewMode}");

            applyIconsToFileNames();

        }).on('fileuploadfail',function (e, dataObj) {

            data = dataObj.jqXHR != null ? dataObj.jqXHR.responseJSON : dataObj;

            if (data.errors.length > 0) {
                $(data.errors).each(function (index) {
                    alert('Error: ' + data.errors[index].source + '\n\nDetails:\n' + data.errors[index].message);
                });
                return;
            }

        }).prop('disabled', !$.support.fileInput)
        .parent().addClass($.support.fileInput ? undefined : 'disabled');

        applyIconsToFileNames();
    });

</script>
